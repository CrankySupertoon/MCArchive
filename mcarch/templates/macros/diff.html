{%- macro author_list(alist) %}
{%- for a in alist %}
{{- a.name }}{% if not loop.last %}, {% endif %}
{%- endfor %}
{%- endmacro %}

{% macro change_list(diff, childname) %}
<ul>
    {% for field, vals in diff.items() %}
    {% if field == 'children' %}
    {# do this later #}
    {% elif field == 'authors' %}
    <li>Change authors from "{{ author_list(vals['old']) }}" to
        "{{ author_list(vals['new']) }}".</li>
    {% else %}
    <li>Change {{ field }} from "{{ vals['old'] }}" to "{{ vals['new'] }}".</li>
    {% endif %}
    {% endfor %}

    {% if 'children' in diff %}
    {% if len(diff['children']['added']) > 0 %}
    <li>Add {{ childname }}:
        <ul>
            {% for ch in diff['children']['added'] %}
            <li>{{ ch.name }}</li>
            {% endfor %}
        </ul>
    </li>
    {% endif %}
    {% if len(diff['children']['removed']) > 0 %}
    <li>Remove {{ childname }}:
        <ul>
            {% for ch in diff['children']['removed'] %}
            <li>{{ ch.name }}</li>
            {% endfor %}
        </ul>
    </li>
    {% endif %}
    {% if len(diff['children']['changed']) > 0 %}
    <li>Change {{ childname }}:
        <ul>
            {% for vsn in diff['children']['changed'] %}
            <li>{{ vsn['new'].filename if childname == files else vsn['new'].name }}
                ({{ vsn['old'].id }}):
                {{ change_list(vsn['changes'], childname='files') }}
                {% endfor %}
            </li>
        </ul>
    </li>
    {% endif %}
    {% endif %}
</ul>
{% endmacro %}

{% macro diff_list(changes, class='block') %}
{% for change in changes %}
{% set mod = change['obj'].current %}
<section class="{{ class }}">
    <a class="right button" href="{{ url_for('mods.mod_history', slug=mod.slug) }}">
        Full Mod History</a>
    <h1><a href="{{ url_for('mods.mod_revision', slug=mod.slug, index=change['obj'].index) }}">
            Revision {{ change['obj'].index }} for {{ mod.name }}</a></h1>
    <p class='small'>By {{ change['user'].name if change['user'] else 'script' }}
    at {{ change['date'] }}</p>
    {{ change_list(change['diff'], childname='versions') }}
</section>
{% endfor %}
{% endmacro %}

